cluster,cluster_size,centroid_query,cluster_total_runtime,cluster_total_runcount,cluster_all_users
-1,338,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path= ""*\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Real-Time Protection\\DisableBehaviorMonitoring"" OR Registry.registry_path= ""*\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Real-Time Protection\\DisableOnAccessProtection"" OR Registry.registry_path= ""*\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Real-Time Protection\\DisableScanOnRealtimeEnable"" OR Registry.registry_path= ""*\\SOFTWARE\\Microsoft\\Windows Defender\\Real-Time Protection\\DisableRealtimeMonitoring"" OR Registry.registry_path= ""*\\Real-Time Protection\\DisableIntrusionPreventionSystem"" OR Registry.registry_path= ""*\\Real-Time Protection\\DisableIOAVProtection"" OR Registry.registry_path= ""*\\Real-Time Protection\\DisableScriptScanning"" AND Registry.registry_value_data = ""0x00000001"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product | `drop_dm_object_name(Registry)` | where isnotnull(registry_value_data) | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `disable_windows_behavior_monitoring_filter`",338.0,338,
0,22,`amazon_security_lake` api.operation=DeleteLogGroup | fillnull | stats count min(_time) as firstTime max(_time) as lastTime by actor.user.uid api.operation api.service.name http_request.user_agent src_endpoint.ip actor.user.account.uid cloud.provider cloud.region | rename actor.user.uid as user api.operation as action api.service.name as dest http_request.user_agent as user_agent src_endpoint.ip as src actor.user.account.uid as vendor_account cloud.provider as vendor_product cloud.region as vendor_region | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `asl_aws_defense_evasion_delete_cloudwatch_log_group_filter`,22.0,22,
1,47,"| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.url IN (""*/api/v2/cmdb/system/admin*"")  Web.http_method IN (""GET"", ""PUT"") by Web.http_user_agent, Web.http_method, Web.url, Web.url_length, Web.src, Web.dest, sourcetype | `drop_dm_object_name(""Web"")` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `fortinet_appliance_auth_bypass_filter`",47.0,47,
2,52,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path= ""*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\DisableTaskMgr"" Registry.registry_value_data = ""0x00000001"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product | `drop_dm_object_name(Registry)` | where isnotnull(registry_value_data) | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `disabling_task_manager_filter`",52.0,52,
3,16,"| tstats `security_content_summariesonly` count values(Registry.registry_key_name) as registry_key_name values(Registry.registry_path) as registry_path min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path IN (""*\\SOFTWARE\\Microsoft\\Cryptography\\Providers\\*"", ""*\\SOFTWARE\\Microsoft\\Cryptography\\OID\\EncodingType*"", ""*\\SOFTWARE\\WOW6432Node\\Microsoft\\Cryptography\\Providers\\*"", ""*\\SOFTWARE\\WOW6432Node\\Microsoft\\Cryptography\\OID\\EncodingType*"") Registry.registry_value_name IN (""Dll"",""$DLL"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product | `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)` | `drop_dm_object_name(Registry)`| `windows_registry_sip_provider_modification_filter`",16.0,16,
4,9,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name IN (""winword.exe"",""excel.exe"",""powerpnt.exe"",""mspub.exe"",""visio.exe"",""onenote.exe"",""onenotem.exe"",""onenoteviewer.exe"",""onenoteim.exe"", ""msaccess.exe"", ""Graph.exe"",""winproj.exe"") `process_rundll32` (Processes.process!=*.dll*) by Processes.dest Processes.user Processes.parent_process_name Processes.parent_process Processes.process_name Processes.process Processes.process_id Processes.parent_process_id | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `office_product_spawning_rundll32_with_no_dll_filter`",9.0,9,
5,104,"`powershell` EventCode=4104 ScriptBlockText = ""*Enable-WindowsOptionalFeature*"" ScriptBlockText = ""*SMB1Protocol*"" | fillnull | stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `powershell_enable_smb1protocol_feature_filter`",104.0,104,
6,18,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=""*find*"" AND Processes.process=""*-exec*"" AND Processes.process=""*sudo*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `linux_find_privilege_escalation_filter`",18.0,18,
7,9,`cisco_duo_administrator` action=policy_update OR action=policy_create | spath input=description | search require_lock=false | rename object as user | stats count min(_time) as firstTime max(_time) as lastTime by action actionlabel description user admin_email | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `cisco_duo_policy_allow_devices_without_screen_lock_filter`,9.0,9,
8,8,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_name IN (""*.keyx.rsa.pvk"",""*sign.rsa.pvk"",""*sign.dsa.pvk"",""*dsa.ec.p8k"",""*dh.ec.p8k"", ""*.pfx"", ""*.der"") by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product | `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)` | `drop_dm_object_name(Filesystem)` | `windows_mimikatz_crypto_export_file_extensions_filter`",8.0,8,
9,5,"| tstats  `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.http_user_agent != null by Web.http_user_agent Web.http_method, Web.url, Web.url_length Web.src, Web.dest | `drop_dm_object_name(""Web"")` | lookup suspicious_c2_user_agents c2_user_agent AS http_user_agent OUTPUT tool, description | where isnotnull(tool) | stats count min(firstTime) as first_seen max(lastTime) as last_seen by tool url http_user_agent src dest description | `security_content_ctime(first_seen)` | `security_content_ctime(last_seen)` | `http_c2_framework_user_agent_filter`",5.0,5,
10,38,"`cisco_asa`\nmessage_id IN (111008, 111010)\ncommand IN (\n    ""aaa authentication*"",\n    ""aaa authorization*"",\n    ""aaa local authentication*"",\n    ""aaa-server*"",\n    ""no aaa*""\n)\n| fillnull\n| stats count\n        earliest(_time) as firstTime\n        latest(_time) as lastTime\n        values(user) as user\n        values(action) as action\n        values(message_id) as message_id\n        values(command) as command\n        values(src_ip) as src_ip\n        values(process_name) as process_name\n  by host\n| `security_content_ctime(firstTime)`\n| `security_content_ctime(lastTime)`\n| `cisco_asa___aaa_policy_tampering_filter`",38.0,38,
11,8,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_path IN (""*sudoers.tmp*"") by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product | `drop_dm_object_name(Filesystem)` | `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)` | `linux_sudoers_tmp_file_creation_filter`",8.0,8,
12,27,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_path IN (""*\\system32\\*"",""*\\syswow64\\*"") Filesystem.file_name=""*.bat"" by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product | `drop_dm_object_name(Filesystem)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `batch_file_write_to_system32_filter`",27.0,27,
13,6,"`cloudtrail` | iplocation sourceIPAddress | search Region=$Region$ | spath output=user path=userIdentity.arn | spath output=awsUserName path=userIdentity.userName | spath output=userType path=userIdentity.type | rename sourceIPAddress as src_ip | table _time, Region, user, userName, userType, src_ip, awsRegion, eventName, errorCode",6.0,6,
14,7,"`crowdstrike_identities` primaryDisplayName = ""*admin*"" | rename riskFactors{}.severity as severity, riskFactors{}.type as risk_type, roles{}.type as role_type, accounts{}.domain as domain, accounts{}.dn as dn, accounts{}.samAccountName as user | stats count min(_time) as firstTime max(_time) as lastTime by  domain dn primaryDisplayName risk_type severity riskScore riskScoreSeverity user role_type | where risk_type = ""DUPLICATE_PASSWORD"" | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `crowdstrike_admin_with_duplicate_password_filter`",7.0,7,
15,8,"`cisco_isovalent_process_exec` process_name IN (""crond"",""cron"",""crontab"")\n| search pod_name!=""""\n| stats count \n        min(_time) as firstTime \n        max(_time) as lastTime \n        values(process) as process\n    by cluster_name pod_name parent_process_name process_name process_exec process_id node_name\n| `security_content_ctime(firstTime)`\n| `security_content_ctime(lastTime)`\n| `cisco_isovalent___cron_job_creation_filter`",8.0,8,
16,30,"| tstats `security_content_summariesonly` count  min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path IN (""*\\Environment\\UserInitMprLogonScript"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product | `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)` | `drop_dm_object_name(Registry)` | `logon_script_event_trigger_execution_filter`",30.0,30,
17,10,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path= ""*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\PushNotifications\\ToastEnabled*"" Registry.registry_value_data=""0x00000000"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product | `drop_dm_object_name(Registry)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `windows_modify_registry_disable_toast_notifications_filter`",10.0,10,
18,21,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path= ""*\\Windows Defender\\Reporting\\DisableGenericRePorts"" Registry.registry_value_data=""0x00000001"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product | `drop_dm_object_name(Registry)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `windows_impair_defense_disable_win_defender_gen_reports_filter`",21.0,21,
19,15,"| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Processes where Processes.process_name=outlook.exe by _time span=1h Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product | `drop_dm_object_name(Processes)` | join process_guid, _time [ | tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_name =""*.dll"" Filesystem.file_path = ""*\\AppData\\Local\\Microsoft\\FORMS\\IPM*"" by _time span=1h Filesystem.dest Filesystem.file_create_time Filesystem.file_name Filesystem.file_path Filesystem.process_guid | `drop_dm_object_name(Filesystem)` | fields file_name file_path process_name process_path process dest file_create_time _time process_guid] | `windows_phishing_outlook_drop_dll_in_form_dir_filter`",15.0,15,
20,10,"| tstats `security_content_summariesonly` count dc(registry_value_name) as registry_value_name_count FROM datamodel=Endpoint.Registry where Registry.registry_path=""*\\SOFTWARE\\Microsoft\\*"" AND Registry.registry_value_data = ""Binary Data"" by _time span=1m Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product | `drop_dm_object_name(Registry)` | eval registry_key_name_len = len(registry_key_name) | eval registry_value_name_len = len(registry_value_name) | regex registry_value_name=""^[0-9a-fA-F]{8}"" | where registry_key_name_len < 80 AND registry_value_name_len == 8 | join process_guid, _time [| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Processes where Processes.process_name IN (""explorer.exe"", ""wermgr.exe"",""dxdiag.exe"", ""OneDriveSetup.exe"", ""mobsync.exe"", ""msra.exe"", ""xwizard.exe"") by _time span=1m Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product | `drop_dm_object_name(Processes)` ] | stats min(_time) as firstTime max(_time) as lastTime values(registry_value_name) as registry_value_name dc(registry_value_name) as registry_value_name_count values(registry_key_name) by dest process_guid process_name parent_process_name | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | where registry_value_name_count >= 5 | `windows_modify_registry_qakbot_binary_data_registry_filter`",10.0,10,
21,18,"`azure_monitor_aad` category=SignInLogs properties.status.errorCode=50126 properties.authenticationDetails{}.succeeded=false | rename properties.* as * | bucket span=5m _time | stats dc(userPrincipalName) AS unique_accounts values(userPrincipalName) as userPrincipalName values(dest) as dest  values(user) as user by _time, src, vendor_account, vendor_product | eventstats avg(unique_accounts) as ip_avg, stdev(unique_accounts) as ip_std by src | eval upperBound=(ip_avg+ip_std*3) | eval isOutlier=if(unique_accounts > 10 and unique_accounts >= upperBound, 1,0) | where isOutlier = 1 | `azure_ad_unusual_number_of_failed_authentications_from_ip_filter`",18.0,18,
22,9,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path=""*\\SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU\\UseWUServer"" AND Registry.registry_value_data=""0x00000001"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product | `drop_dm_object_name(Registry)` | `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)` | `windows_modify_registry_usewuserver_filter`",9.0,9,
23,16,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_value_name=""DisableAntiSpyware"" AND Registry.registry_value_data=""0x00000001"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product | `drop_dm_object_name(Registry)` | `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)` | `windows_disableantispyware_registry_filter`",16.0,16,
24,25,"`m365_exported_ediscovery_prompt_logs`\n| search Subject_Title IN (\n                            ""*act as*"",\n                            ""*bypass*"",\n                            ""*ignore*"",\n                            ""*override*"",\n                            ""*pretend you are*"",\n                            ""*rules=*""\n                          )\n| eval user = Sender\n| eval jailbreak_score=case(\n                            match(Subject_Title, ""(?i)pretend you are.*amoral""), 4,\n                            match(Subject_Title, ""(?i)act as.*entities""), 3,\n                            match(Subject_Title, ""(?i)(ignore|bypass|override)""), 3,\n                            match(Subject_Title, ""(?i)rules\s*=""), 4, 1=1, 1\n)\n| where jailbreak_score >= 2\n| table _time, user, Subject_Title, jailbreak_score, Workload, Size\n| sort -jailbreak_score, -_time\n| `m365_copilot_jailbreak_attempts_filter`",25.0,25,
25,14,"`cisco_network_visibility_module_flowdata`\nprocess_name IN (\n  ""backgroundtaskhost.exe"", ""svchost.exe"", ""dllhost.exe"", ""werfault.exe"",\n  ""searchprotocolhost.exe"", ""wuauclt.exe"", ""spoolsv.exe"", ""rundll32.exe"",\n  ""regasm.exe"", ""regsvr32.exe"", ""regsvcs.exe""\n)\nNOT process_arguments=""*""\nNOT dest IN (\n        ""10.0.0.0/8"", ""172.16.0.0/12"", ""192.168.0.0/16"", ""100.64.0.0/10"",\n        ""127.0.0.0/8"", ""169.254.0.0/16"", ""192.0.0.0/24"", ""192.0.0.0/29"", ""192.0.0.8/32"",\n        ""192.0.0.9/32"", ""192.0.0.10/32"", ""192.0.0.170/32"", ""192.0.0.171/32"", ""192.0.2.0/24"",\n        ""192.31.196.0/24"", ""192.52.193.0/24"", ""192.88.99.0/24"", ""224.0.0.0/4"", ""192.175.48.0/24"",\n        ""198.18.0.0/15"", ""198.51.100.0/24"", ""203.0.113.0/24"", ""240.0.0.0/4"", ""::1""\n        )\n| stats count min(_time) as firstTime max(_time) as lastTime\n        values(parent_process_arguments) as parent_process_arguments\n        values(process_arguments) as process_arguments\n        values(parent_process_hash) as parent_process_hash\n        values(process_hash) as process_hash\n        values(module_name_list) as module_name_list\n        values(module_hash_list) as module_hash_list\n        values(dest_port) as dest_port\n        values(aliul) as additional_logged_in_users_list\n        values(dest_hostname) as dest_hostname\n        by src dest parent_process_path parent_process_integrity_level process_path process_name process_integrity_level process_id transport\n| `security_content_ctime(firstTime)`\n| `security_content_ctime(lastTime)`\n| table\n  parent_process_integrity_level parent_process_path parent_process_arguments parent_process_hash\n  process_integrity_level process_path process_name process_arguments process_hash process_id\n  additional_logged_in_users_list module_name_list module_hash_list\n  src dest_hostname dest dest_port transport firstTime lastTime\n| `cisco_nvm___suspicious_network_connection_from_process_with_no_args_filter`",14.0,14,
26,18,"| tstats count `security_content_summariesonly` earliest(_time) as first_login latest(_time) as last_login dc(Authentication.dest) AS distinct_count_dest values(Authentication.dest) AS Authentication.dest values(Authentication.app) AS Authentication.app  from datamodel=Authentication where Authentication.action=failure by Authentication.user | where distinct_count_dest > 1 | `security_content_ctime(first_login)` | `security_content_ctime(last_login)` | `drop_dm_object_name(""Authentication"")` | search user=$user$",18.0,18,
27,7,"`circleci` | rename workflows.job_id AS job_id | join job_id [ | search `circleci` | stats values(name) as step_names count by job_id job_name ] | stats count by step_names job_id job_name vcs.committer_name vcs.subject vcs.url owners{} | rename vcs.* as * , owners{} as user | lookup mandatory_step_for_job job_name OUTPUTNEW step_name AS mandatory_step | search mandatory_step=* | eval mandatory_step_executed=if(like(step_names, ""%"".mandatory_step.""%""), 1, 0) | where mandatory_step_executed=0 | rex field=url ""(?<repository>[^\/]*\/[^\/]*)$"" | eval phase=""build""  | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `circle_ci_disable_security_step_filter`",7.0,7,
28,7,"`powershell` EventCode=4104 AND ScriptBlockText IN (""*SELECT*"", ""*Get-WmiObject*"") AND ScriptBlockText IN (""*Win32_Bios*"", ""*Win32_OperatingSystem*"", ""*Win32_Processor*"", ""*Win32_ComputerSystem*"", ""*Win32_PnPEntity*"", ""*Win32_ShadowCopy*"", ""*Win32_DiskDrive*"", ""*Win32_PhysicalMemory*"", ""*Win32_BaseBoard*"", ""*Win32_DisplayConfiguration*"") | fillnull | stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `recon_using_wmi_class_filter`",7.0,7,
29,7,"| tstats `security_content_summariesonly` \n  count min(_time) as firstTime \n  max(_time) as lastTime \nFROM datamodel=Endpoint.Filesystem where \n  Filesystem.file_name IN (""*.zip"", ""*.rar"", ""*.tar"", ""*.7z"") \n  Filesystem.file_path IN (""*\\AppData\\Local\\Temp\\*"", ""*\\Windows\\Temp\\*"")\nby Filesystem.action Filesystem.dest Filesystem.file_access_time \n   Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time \n   Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size \n   Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product \n| `drop_dm_object_name(Filesystem)` \n| `security_content_ctime(firstTime)`\n| `security_content_ctime(lastTime)` \n| `windows_archived_collected_data_in_temp_folder_filter`",7.0,7,
30,6,"| tstats `security_content_summariesonly` count values(Processes.process_path) as process_path min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process = ""*     .*"" by Processes.dest Processes.user Processes.process Processes.process_name | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `drop_dm_object_name(Processes)` | `execution_of_file_with_spaces_before_extension_filter`",6.0,6,
31,25,| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=PlistBuddy (Processes.process=*LaunchAgents* OR Processes.process=*RunAtLoad* OR Processes.process=*true*) by Processes.dest Processes.user Processes.parent_process Processes.process_name Processes.process Processes.process_id Processes.parent_process_id | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` |  `suspicious_plistbuddy_usage_filter`,25.0,25,
32,37,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time)\nas lastTime FROM datamodel=Endpoint.Processes where\n(Processes.process_name=regsvcs.exe OR Processes.original_file_name=RegSvcs.exe)\nProcesses.process IN (""*regsvcs"",""*regsvcs.exe"", ""*regsvcs.exe\"""")\nby Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec\n   Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name\n   Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid\n   Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name\n   Processes.process_path Processes.user Processes.user_id Processes.vendor_product\n| `drop_dm_object_name(Processes)`\n| `security_content_ctime(firstTime)`\n| `security_content_ctime(lastTime)`\n| `detect_regsvcs_with_no_command_line_arguments_filter`",37.0,37,
33,20,"| tstats `security_content_summariesonly` \n  count min(_time) as firstTime \n  max(_time) as lastTime \nfrom datamodel=Endpoint.Processes where \n`process_rundll32` \nProcesses.process IN (""*syssetup*"", ""*advpack*"", ""*setupapi*"")\nProcesses.process IN (""*LaunchINFSection*"", ""*InstallHinfSection*"", ""*SetupInfObjectInstallAction*"")\nby Processes.action Processes.dest Processes.original_file_name Processes.parent_process\n   Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id\n   Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec\n   Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level\n   Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product\n| `drop_dm_object_name(Processes)` \n| `security_content_ctime(firstTime)` \n| `security_content_ctime(lastTime)`\n| `windows_application_whitelisting_bypass_attempt_via_rundll32_filter`",20.0,20,
34,9,"`sysmon` EventCode=7 ImageLoaded IN (""*\\AclNumsInvertHost.dll"", ""*\\ModeBitmapNumericAnimate.dll"", ""*\\UnregisterAncestorAppendAuto.dll"", ""*\\DeregisterSeekUsers.dll"", ""*\\ScrollbarHandleGet.dll"", ""*\\PerformanceCaptionApi.dll"", ""*\\WowIcmpRemoveReg.dll"", ""*\\BlendMonitorStringBuild.dll"", ""*\\HandleFrequencyAll.dll"", ""*\\HardSwapColor.dll"", ""*\\LengthInMemoryActivate.dll"", ""*\\ParametersNamesPopup.dll"", ""*\\ModeFolderSignMove.dll"", ""*\\ChildPaletteConnected.dll"", ""*\\AddressResourcesSpec.dll"") | fillnull | stats count min(_time) as firstTime max(_time) as lastTime by Image ImageLoaded dest loaded_file loaded_file_path original_file_name process_exec process_guid process_hash process_id process_name process_path service_dll_signature_exists service_dll_signature_verified signature signature_id user_id vendor_product | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `windows_known_graphicalproton_loaded_modules_filter`",9.0,9,
35,62,"`sysmon` EventCode=8 SourceImage = ""*\\wermgr.exe"" TargetImage IN (""*\\firefox.exe"", ""*\\chrome.exe"", ""*\\iexplore.exe"",""*\\microsoftedgecp.exe"") | stats count min(_time) as firstTime max(_time) as lastTime by EventID Guid NewThreadId ProcessID SecurityID SourceImage SourceProcessGuid SourceProcessId StartAddress StartFunction StartModule TargetImage TargetProcessGuid TargetProcessId UserID dest parent_process_exec parent_process_guid parent_process_id parent_process_name parent_process_path process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `windows_process_injection_of_wermgr_to_known_browser_filter`",62.0,62,
36,15,"| tstats earliest(_time) as firstTimeSeen, latest(_time) as lastTimeSeen from datamodel=Change where All_Changes.action=created  by All_Changes.Instance_Changes.image_id | `drop_dm_object_name(""All_Changes"")` | `drop_dm_object_name(""Instance_Changes"")` | where image_id != ""unknown"" | eventstats min(firstTimeSeen) as globalFirstTime | eval enough_data = if(globalFirstTime <= relative_time(now(), ""-7d@d""), 1, 0) | outputlookup previously_seen_cloud_compute_images",15.0,15,
37,10,"`wineventlog_security` EventCode=4663 NOT (ProcessName IN (""*\\firefox.exe"", ""*\\explorer.exe"", ""*sql*"")) ObjectName=""*\\AppData\\Roaming\\Mozilla\\Firefox\\Profiles*"" | stats count min(_time) as firstTime max(_time) as lastTime by ObjectName ObjectType ProcessName AccessMask EventCode dest | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `non_firefox_process_access_firefox_profile_dir_filter`",10.0,10,
38,5,"| tstats `security_content_summariesonly` count, min(_time) as firstTime, max(_time) as lastTime from datamodel=Network_Traffic where (All_Traffic.app=rdp OR All_Traffic.dest_port=3389) AND All_Traffic.action=allowed by All_Traffic.src, All_Traffic.dest, All_Traffic.dest_port All_Traffic.user All_Traffic.vendor_product  | `drop_dm_object_name(""All_Traffic"")`  | eval duration=lastTime-firstTime  | where count > 10 AND duration < 3600  | `security_content_ctime(firstTime)`  | `security_content_ctime(lastTime)`  | `remote_desktop_network_bruteforce_filter`",5.0,5,
39,5,"| tstats `security_content_summariesonly` count values(All_Changes.command) as command min(_time) as firstTime max(_time) as lastTime from datamodel=Change.All_Changes where ( (All_Changes.command=""*snmp-server community*rw*"") OR (All_Changes.command=""*snmp-server community*ro*"") OR (All_Changes.command=""*snmp-server host*"") ) by All_Changes.dvc All_Changes.user | `drop_dm_object_name(""All_Changes"")` | rename dvc as dest | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `cisco_snmp_community_string_configuration_changes_filter`",5.0,5,
40,13,"`aws_s3_accesslogs` http_status=200  [search `aws_s3_accesslogs` http_status=200 | stats earliest(_time) as firstTime latest(_time) as lastTime by bucket_name remote_ip | inputlookup append=t previously_seen_S3_access_from_remote_ip | stats min(firstTime) as firstTime, max(lastTime) as lastTime by bucket_name remote_ip | outputlookup previously_seen_S3_access_from_remote_ip | eval newIP=if(firstTime >= relative_time(now(), ""-70m@m""), 1, 0) | where newIP=1 | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | table bucket_name remote_ip]| iplocation remote_ip |rename remote_ip as src_ip | table _time bucket_name src_ip City Country operation request_uri | `detect_s3_access_from_a_new_ip_filter`",13.0,13,
41,12,`aws_cloudwatchlogs_eks` user.groups{}=system:serviceaccounts responseStatus.status = Failure | table sourceIPs{} user.username userAgent verb responseStatus.status requestURI | `kubernetes_aws_detect_service_accounts_forbidden_failure_access_filter`,12.0,12,
42,34,`kubernetes_azure` category=kube-audit | spath input=properties.log| search objectRef.resource=clusterroles OR clusterrolebindings | table sourceIPs{} user.username user.groups{} objectRef.namespace requestURI annotations.authorization.k8s.io/reason | dedup user.username user.groups{} |`kubernetes_azure_detect_sensitive_role_access_filter`,34.0,34,
43,9,"`wineventlog_security` ((EventCode=5137  ObjectClass=""dnsNode"") OR (EventCode=5136 ObjectClass=""dnsNode"" AttributeLDAPDisplayName=""dNSTombstoned"" AttributeValue=""TRUE"")) | stats min(_time) as firstTime max(_time) as lastTime values(EventCode) as event_codes values(ObjectDN) as dns_record values(SubjectUserName) as user values(Computer) as dest by ObjectGUID | where mvcount(event_codes)=2 | eval time_diff=lastTime - firstTime | where time_diff <= 300 | table firstTime, lastTime, dns_record, user, dest, time_diff, ObjectGUID | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `windows_short_lived_dns_record_filter`",9.0,9,
44,12,"`wineventlog_security` EventCode=4663 object_file_path IN (""*\\Profiles\\Outlook\\9375CFF0413111d3B88A00104B2A6676*"", ""*\\Windows Messaging Subsystem\\Profiles\\9375CFF0413111d3B88A00104B2A6676*"") AND process_name != *\\outlook.exe | stats count min(_time) as firstTime max(_time) as lastTime by object_file_name object_file_path process_name process_path  process_id EventCode dest | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `windows_unsecured_outlook_credentials_access_in_registry_filter`",12.0,12,
45,8,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.parent_process_name=services.exe) (Processes.process_name IN (""Regsvcs.exe"", ""Ftp.exe"", ""OfflineScannerShell.exe"", ""Rasautou.exe"", ""Schtasks.exe"", ""Xwizard.exe"", ""Dllhost.exe"", ""Pnputil.exe"", ""Atbroker.exe"", ""Pcwrun.exe"", ""Ttdinject.exe"",""Mshta.exe"", ""Bitsadmin.exe"", ""Certoc.exe"", ""Ieexec.exe"", ""Microsoft.Workflow.Compiler.exe"", ""Runscripthelper.exe"", ""Forfiles.exe"", ""Msbuild.exe"", ""Register-cimprovider.exe"", ""Tttracer.exe"", ""Ie4uinit.exe"", ""Bash.exe"", ""Hh.exe"", ""SettingSyncHost.exe"", ""Cmstp.exe"", ""Mmc.exe"", ""Stordiag.exe"", ""Scriptrunner.exe"", ""Odbcconf.exe"", ""Extexport.exe"", ""Msdt.exe"", ""WorkFolders.exe"", ""Diskshadow.exe"", ""Mavinject.exe"", ""Regasm.exe"", ""Gpscript.exe"", ""Rundll32.exe"", ""Regsvr32.exe"", ""Msiexec.exe"", ""Wuauclt.exe"", ""Presentationhost.exe"", ""Wmic.exe"", ""Runonce.exe"", ""Syncappvpublishingserver.exe"", ""Verclsid.exe"", ""Infdefaultinstall.exe"", ""Explorer.exe"", ""Installutil.exe"", ""Netsh.exe"", ""Wab.exe"", ""Dnscmd.exe"", ""At.exe"", ""Pcalua.exe"", ""Msconfig.exe"")) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `services_lolbas_execution_process_spawn_filter`",8.0,8,
46,6,"`sysmon` EventCode IN (17, 18) EventType IN ( ""CreatePipe"", ""ConnectPipe"") Image IN (""*\\calc.exe"", ""*\\notepad.exe"", ""*\\rdpclip.exe"", ""*\\explorer.exe"", ""*\\wermgr.exe"", ""*\\ping.exe"", ""*\\OneDriveSetup.exe"", ""*\\dxdiag.exe"", ""*\\mobsync.exe"", ""*\\msra.exe"", ""*\\xwizard.exe"") | regex PipeName=""^\\\{[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{8}"" | stats  min(_time) as firstTime max(_time) as lastTime count by dest dvc pipe_name process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product Image PipeName | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `windows_app_layer_protocol_qakbot_namedpipe_filter`",6.0,6,
47,10,"`cloudtrail` (eventName=Run* OR eventName=Create*) | iplocation sourceIPAddress | stats earliest(_time) as firstTime, latest(_time) as lastTime by sourceIPAddress, City, Region, Country | outputlookup previously_seen_provisioning_activity_src | stats count",10.0,10,
48,25,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime\nfrom datamodel=Endpoint.Processes where\n(\n  Processes.process_name IN (""copy.exe"", ""xcopy.exe"")\n  OR\n  Processes.original_file_name IN (""copy.exe"", ""xcopy.exe"")\n)\nProcesses.process IN (\n  ""*.7z*"",\n  ""*.bmp*"",\n  ""*.db*"",\n  ""*.doc*"",\n  ""*.gif*"",\n  ""*.gz*"",\n  ""*.jpg*"",\n  ""*.log*"",\n  ""*.pdf*"",\n  ""*.png*"",\n  ""*.ppt*"",\n  ""*.rar*"",\n  ""*.rtf*"",\n  ""*.tar*"",\n  ""*.txt*"",\n  ""*.xls*"",\n  ""*.zip*""\n)\nby Processes.action Processes.dest Processes.original_file_name\nProcesses.parent_process Processes.parent_process_exec Processes.parent_process_guid\nProcesses.parent_process_id Processes.parent_process_name Processes.parent_process_path\nProcesses.process Processes.process_exec Processes.process_guid Processes.process_hash\nProcesses.process_id Processes.process_integrity_level Processes.process_name Processes.process_path\nProcesses.user Processes.user_id Processes.vendor_product \n| `drop_dm_object_name(Processes)`\n| `security_content_ctime(firstTime)`\n| `security_content_ctime(lastTime)` \n| `windows_file_collection_via_copy_utilities_filter`",25.0,25,
49,5,"`cloudtrail` eventName=ConsoleLogin action=failure | bucket span=10m _time | rename user_name as user | stats dc(_raw) AS failed_attempts values(src) as src values(user_agent) as user_agent by _time, user, signature, dest, vendor_account vendor_region, vendor_product | where failed_attempts > 20 | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `aws_high_number_of_failed_authentications_for_user_filter`",5.0,5,
50,25,"`github_organizations` vendor_action=protected_branch.destroy | fillnull | stats count min(_time) as firstTime max(_time) as lastTime by actor, actor_id, actor_ip, actor_is_bot, actor_location.country_code, business, business_id, org, org_id, repo, repo_id, user_agent, vendor_action, name | eval user=actor | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `github_organizations_disable_classic_branch_protection_rule_filter`",25.0,25,
51,8,`sysmon` EventCode=21 | stats count min(_time) as firstTime max(_time) as lastTime by dest dvc object object_attrs object_category object_path signature signature_id src status user user_id vendor_product Consumer ConsumerNoQuotes Filter FilterNoQuotes | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `wmi_permanent_event_subscription___sysmon_filter`,8.0,8,
52,28,"`sysmon` EventCode=5 process_name IN (""PServiceControl.exe"", ""PService_PPD.exe"") | stats min(_time) as firstTime max(_time) as lastTime count by dest process process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `windows_processes_killed_by_industroyer2_malware_filter`",28.0,28,
53,9,"`wineventlog_security` (EventCode=4742 OR EventCode=4738) NOT SidHistory IN (""%%1793"", -) | rex field=SidHistory ""(^%{|^)(?P<SidHistoryMatch>.*)(\-|\\\)"" | rex field=TargetSid ""^(?P<TargetSidmatch>.*)(\-|\\\)"" | where SidHistoryMatch!=TargetSidmatch AND SidHistoryMatch!=TargetDomainName | rename TargetSid as userSid | table _time action status host user userSid SidHistory Logon_ID src_user dest | `windows_ad_cross_domain_sid_history_addition_filter`",9.0,9,
54,7,"`sysmon`\n(EventCode=17 OR EventCode=18)\nNOT process_path IN (\n  ""*:\\Program Files \(x86\)\\Adobe*"",\n  ""*:\\Program Files \(x86\)\\Google*"",\n  ""*:\\Program Files \(x86\)\\Microsoft*"",\n  ""*:\\Program Files\\Adobe*"",\n  ""*:\\Program Files\\Google*"",\n  ""*:\\Program Files\\Microsoft*"",\n  ""*:\\Windows\\system32\\SearchIndexer.exe"",\n  ""*:\\Windows\\System32\\svchost.exe"",\n  ""*:\\Windows\\SystemApps\\Microsoft*"",\n  ""*\\Amazon\\SSM\\Instance*"",\n  ""*\\AppData\\Local\\Google*"",\n  ""*\\AppData\\Local\\Kingsoft\\*"",\n  ""*\\AppData\\Local\\Microsoft*"",\n  ""System""\n)\n\n| stats  min(_time) as firstTime max(_time) as lastTime\ncount by dest dvc process_exec process_guid process_id process_path signature signature_id \nvendor_product pipe_name user_id Image process_name\n\n| lookup suspicious_rmm_named_pipes suspicious_pipe_name AS pipe_name OUTPUT tool, description\n| where isnotnull(tool)\n| `security_content_ctime(firstTime)`\n| `security_content_ctime(lastTime)`\n| `windows_rmm_named_pipe_filter`",7.0,7,
55,8,"| tstats `security_content_summariesonly`\n  count min(_time) as firstTime\n        max(_time) as lastTime\n\nFROM datamodel=Endpoint.Filesystem where\n\nFilesystem.action=""created""\nFilesystem.file_name=""*.lnk""\nFilesystem.file_path IN (\n  ""*:\\AppData\\Local\\Temp\\*"",\n  ""*:\\Temp\\*"",\n  ""*:\\Users\\*"",\n  ""*:\\Windows\\Temp\\*""\n)\nNOT Filesystem.file_path IN (\n  ""*\\AppData\\Local\\Microsoft\\Windows\\WinX\\*"",\n  ""*\\AppData\\Roaming\\Microsoft\\Excel\\*"",\n  ""*\\AppData\\Roaming\\Microsoft\\Internet Explorer\\Quick Launch\\*"",\n  ""*\\AppData\\Roaming\\Microsoft\\Office\\Recent\\*"",\n  ""*\\AppData\\Roaming\\Microsoft\\Windows\\Recent\\*"",\n  ""*\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\*"",\n  ""*\\AppData\\Roaming\\Microsoft\\Word\\*"",\n  ""*\\Links\\*"",\n  ""*\\OneDrive *""\n)\n\nby Filesystem.action Filesystem.dest Filesystem.file_access_time\n   Filesystem.file_create_time Filesystem.file_hash\n   Filesystem.file_modify_time Filesystem.file_name\n   Filesystem.file_path Filesystem.file_acl Filesystem.file_size\n   Filesystem.process_guid Filesystem.process_id\n   Filesystem.user Filesystem.vendor_product\n\n| `drop_dm_object_name(Filesystem)`\n| `security_content_ctime(firstTime)`\n| `security_content_ctime(lastTime)`\n| `process_creating_lnk_file_in_suspicious_location_filter`",8.0,8,
56,15,"`okta` eventType=""user.authentication.auth_via_mfa"" AND result=""FAILURE"" AND outcome.reason=""FastPass declined phishing attempt"" | stats count min(_time) as firstTime max(_time) as lastTime values(displayMessage) by user eventType client.userAgent.rawUserAgent client.userAgent.browser outcome.reason | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `okta_phishing_detection_with_fastpass_origin_check_filter`",15.0,15,
57,8,`linux_auditd` type=SYSCALL comm=modprobe | rename host as dest | stats count min(_time) as firstTime max(_time) as lastTime by comm exe  syscall uid ppid pid success dest | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `linux_auditd_install_kernel_module_using_modprobe_utility_filter`,8.0,8,
58,8,"| mstats avg(tcp.*) as tcp.* avg(udp.*) as udp.* where `kubernetes_metrics` AND earliest=-1h by k8s.cluster.name source.workload.name dest.workload.name span=10s | eval key='source.workload.name' + "":"" + 'dest.workload.name' | join type=left key [ mstats avg(tcp.*) as avg_tcp.* avg(udp.*) as avg_udp.* stdev(tcp.*) as stdev_tcp.* avg(udp.*) as stdev_udp.* where `kubernetes_metrics` AND earliest=-30d latest=-1h by source.workload.name dest.workload.name | eval key='source.workload.name' + "":"" + 'dest.workload.name' ] | eval anomalies = """" | foreach stdev_* [ eval anomalies =if( '<<MATCHSTR>>' > ('avg_<<MATCHSTR>>' + 3 * 'stdev_<<MATCHSTR>>'), anomalies + ""<<MATCHSTR>> higher than average by "" + tostring(round(('<<MATCHSTR>>' - 'avg_<<MATCHSTR>>')/'stdev_<<MATCHSTR>>' ,2)) + "" Standard Deviations. <<MATCHSTR>>="" + tostring('<<MATCHSTR>>') + "" avg_<<MATCHSTR>>="" + tostring('avg_<<MATCHSTR>>') + "" 'stdev_<<MATCHSTR>>'="" + tostring('stdev_<<MATCHSTR>>') + "", "" , anomalies) ] | fillnull | eval anomalies = split(replace(anomalies, "",\s$$$$"", """") ,"", "") | where anomalies!="""" | stats count(anomalies) as count values(anomalies) as anomalies by k8s.cluster.name source.workload.name dest.workload.name | rename service as k8s.service | where count > 5 | rename k8s.cluster.name as host | `kubernetes_anomalous_traffic_on_network_edge_filter`",8.0,8,
59,6,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name IN( ""icacls.exe"", ""cacls.exe"", ""xcacls.exe"")  AND Processes.process = ""*/inheritance:r*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `windows_file_and_directory_permissions_remove_inheritance_filter`",6.0,6,
60,9,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = ""taskkill.exe"" Processes.process IN (""* /f*"", ""* /t*"") Processes.process IN (""* /im*"", ""* /pid*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product | `drop_dm_object_name(""Processes"")` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `windows_disable_or_modify_tools_via_taskkill_filter`",9.0,9,
61,15,`linux_auditd` type=DAEMON_ABORT | rename host as dest | stats count min(_time) as firstTime max(_time) as lastTime by type op res uid dest pid | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `linux_auditd_auditd_daemon_abort_filter`,15.0,15,
62,18,"`linux_auditd` execve_command IN (""*xclip*"", ""*clipboard*"") AND execve_command IN (""*-o*"", ""*-selection *"", ""*-sel *"" ) | rename host as dest | rename comm as process_name | rename exe as process | stats count min(_time) as firstTime max(_time) as lastTime by argc execve_command dest | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `linux_auditd_clipboard_data_copy_filter`",18.0,18,
63,32,"`o365_management_activity` Workload=AzureActiveDirectory Operation IN (""Add application."",""Update application."") ModifiedProperties{}.Name=AvailableToOtherTenants | eval result = case(match(mvindex('ModifiedProperties{}.NewValue',mvfind('ModifiedProperties{}.Name',""AvailableToOtherTenants"")),""false""),""removed"",true(),""added""), object_name=mvindex('Target{}.ID', 3), signature=Operation, object_attrs = ""AvailableToOtherTenants"", user = case(match(mvindex('Actor{}.ID',-1),""User""),mvindex('Actor{}.ID',0),match(mvindex('Actor{}.ID',-1),""ServicePrincipal""),mvindex('Actor{}.ID',3),true(),mvindex('Actor{}.ID',0)) | search result = ""added"" | fillnull | stats count min(_time) as firstTime max(_time) as lastTime by signature dest user src vendor_account vendor_product object_attrs object_name | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `o365_application_available_to_other_tenants_filter`",32.0,32,
64,7,"`o365_management_activity` Operation=""Add member to role."" Workload=AzureActiveDirectory | eval role_id = mvindex('ModifiedProperties{}.NewValue',2) | eval role_name = mvindex('ModifiedProperties{}.NewValue',1) | where role_id IN (""29232cdf-9323-42fd-ade2-1d097af3e4de"", ""f28a1f50-f6e7-4571-818b-6a12f2af6b6c"", ""62e90394-69f5-4237-9190-012177145e10"") | fillnull | stats count min(_time) as firstTime max(_time) as lastTime by signature dest user src vendor_account vendor_product ObjectId role_name role_id | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `o365_high_privilege_role_granted_filter`",7.0,7,
65,6,"`wineventlog_security` EventCode IN (4698,4700,4702)\n| eval TaskContent = case(isnotnull(TaskContentNew),TaskContentNew,true(),TaskContent)\n| xmlkv TaskContent\n| stats count min(_time) as firstTime max(_time) as lastTime latest(Arguments) as Arguments latest(Author) as Author by Computer, TaskName, Command, Enabled, Hidden,Caller_User_Name, EventCode\n| lookup windows_suspicious_tasks task_name as TaskName \n| where isnotnull(tool_type)\n| eval command=TaskName, process=Command+if(isnotnull(Arguments),"" "".Arguments,""""), src_user=Author, user = Caller_User_Name, dest = Computer\n| `security_content_ctime(firstTime)` \n| `security_content_ctime(lastTime)`\n| `windows_scheduled_task_with_suspicious_name_filter`",6.0,6,
66,7,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""powershell.exe"") (Processes.process=*Get-AdGroup*) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `getadgroup_with_powershell_filter`",7.0,7,
67,19,"`esxi_syslog` Message=""*esxcli system auditrecords*"" Message IN (""*remote*"",""*local*"") NOT Message = ""*[shell*"" | rex field=_raw ""Z (?<dest>[\w\.]+)\s"" | rex field=_raw ""[\w+]\]: (?<full_command>.*)"" | rex field=full_command ""\[(?<user>.*)]:\s(?<command>.*)"" | stats min(_time) as firstTime max(_time) as lastTime count by dest user command | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `esxi_audit_tampering_filter`",19.0,19,
68,5,"`esxi_syslog` Message=""*network firewall set*"" AND Message=""*enabled f*"" | rex field=_raw ""Z (?<dest>[\w\.]+)\s"" | stats min(_time) as firstTime max(_time) as lastTime count by dest Message | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `esxi_firewall_disabled_filter`",5.0,5,
69,12,"`okta` eventType=user.session.start outcome.result=FAILURE | rename client.geographicalContext.country as country, client.geographicalContext.state as state, client.geographicalContext.city as city | stats min(_time) as firstTime max(_time) as lastTime dc(src_user) as distinct_users values(src_user) as users by src_ip, displayMessage, outcome.reason, country, state, city | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | search distinct_users > 5| `multiple_okta_users_with_invalid_credentials_from_the_same_ip_filter`",12.0,12,
70,15,"`kube_audit` ""user.groups{}""=""system:unauthenticated"" ""responseStatus.code""=403 | iplocation sourceIPs{} | stats count values(userAgent) as userAgent values(user.username) as user.username values(user.groups{}) as user.groups{} values(verb) as verb values(requestURI) as requestURI values(responseStatus.code) as responseStatus.code values(responseStatus.message) as responseStatus.message values(responseStatus.reason) as responseStatus.reason values(responseStatus.status) as responseStatus.status by sourceIPs{} Country City | where count > 5 | rename sourceIPs{} as src_ip, user.username as user | `kubernetes_scanning_by_unauthenticated_ip_address_filter`",15.0,15,
71,35,| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=*get-domaintrust* by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `get_domaintrust_with_powershell_filter`,35.0,35,
72,22,| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_regsvr32` Processes.process=*scrobj* by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `detect_regsvr32_application_control_bypass_filter`,22.0,22,
73,38,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""cmd.exe"" OR Processes.process_name=""powershell*"") AND Processes.process = ""*Get-DomainUser*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `get_domainuser_with_powershell_filter`",38.0,38,
74,14,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = ""bcdedit.exe"" Processes.process = ""*bootstatuspolicy*""  Processes.process = ""*ignoreallfailures*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)`| `prevent_automatic_repair_mode_using_bcdedit_filter`",14.0,14,
75,15,"`zscaler_proxy` action=blocked threatname!=""None"" threatclass=""Behavior Analysis"" | stats count min(_time) as firstTime max(_time) as lastTime by action deviceowner user threatname url src dest | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `zscaler_behavior_analysis_threat_blocked_filter`",15.0,15,
76,66,"`wineventlog_security`  EventCode=4887 | stats count min(_time) as firstTime max(_time) as lastTime by dest, name, Requester, action, Attributes, Subject | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)`| `windows_steal_authentication_certificates_certificate_issued_filter`",66.0,66,
77,26,"| tstats `security_content_summariesonly` \n  min(_time) as firstTime \n  max(_time) as lastTime \n  values(Processes.dest) as dest\n  values(Processes.user) as user \n  values(Processes.action) as action \n  values(Processes.original_file_name) as original_file_name \n  values(Processes.parent_process_exec) as parent_process_exec \n  values(Processes.parent_process_guid) as parent_process_guid\n  values(Processes.parent_process_id) as parent_process_id \n  values(Processes.parent_process_path) as parent_process_path \n  values(Processes.process) as process \n  values(Processes.process_exec) as process_exec \n  values(Processes.process_guid) as process_guid \n  values(Processes.process_hash) as process_hash \n  values(Processes.process_id) as process_id \n  values(Processes.process_integrity_level) as process_integrity_level \n  values(Processes.process_name) as process_name \n  values(Processes.process_path) as process_path \n  values(Processes.user_id) as user_id \n  values(Processes.vendor_product) as vendor_product count \nfrom datamodel=Endpoint.Processes where \nProcesses.process_name IN( ""icacls.exe"", ""cacls.exe"", ""xcacls.exe"") \nby Processes.parent_process_name Processes.parent_process Processes.dest Processes.user _time span=1m \n| where count >=10 \n| `drop_dm_object_name(Processes)`\n| `security_content_ctime(firstTime)` \n| `security_content_ctime(lastTime)` \n| `excessive_usage_of_cacls_app_filter`",26.0,26,
78,10,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = bcdedit.exe Processes.process=""*/set*"" Processes.process=""*{current}*""  Processes.process=""*safeboot*"" Processes.process=""*network*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product |`drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `change_to_safe_mode_with_network_config_filter`",10.0,10,
79,9,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=""*openvpn*"" AND Processes.process=""*--dev*"" AND Processes.process=""*--script-security*"" AND Processes.process=""*--up*"" AND Processes.process=""*sudo*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `linux_openvpn_privilege_escalation_filter`",9.0,9,
80,7,"| tstats `security_content_summariesonly` count from datamodel=Network_Traffic where All_Traffic.dest_port=3389 by All_Traffic.src | `drop_dm_object_name(""All_Traffic"")` | sort - count",7.0,7,
81,17,| search `netbackup` dest=$dest$,17.0,17,
82,14,"`azure_monitor_aad` category=SignInLogs operationName=""Sign-in activity"" | rename properties.* as * | search status.errorCode=500121 status.additionalDetails=""MFA denied; user declined the authentication"" | bucket span=10m _time | rename userAgent as user_agent | fillnull | stats count min(_time) as firstTime max(_time) as lastTime values(dest) as dest values(user_agent) as user_agent values(src) as src by user status.additionalDetails vendor_account vendor_product signature _time | where count > 9 | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `azure_ad_multiple_denied_mfa_requests_for_user_filter`",14.0,14,
83,11,"`crowdstrike_stream` metadata.eventType IN (XdrDetectionSummaryEvent,IdpDetectionSummaryEvent,EppDetectionSummaryEvent) \n| rename event.* as * \n| eval risk_score=case(Severity<20, 0, Severity<40 AND Severity>=20, 25, Severity<60 AND Severity>=40, 100, Severity<80 AND Severity>=60, 250, Severity>=80, 500) \n| eval user=coalesce(lower(SourceAccountName),lower(UserName)) \n| eval dest=coalesce(HostNames,SourceEndpointHostName)\n| eval mitre_technique = case(!match(Name, ""(NGAV\n|Intel Detection)""), Technique)\n| join type=left mitre_technique \n [| inputlookup append=t mitre_attack_lookup \n  | fields mitre_technique mitre_technique_id ] \n| eval annotations.mitre_attack = mitre_technique_id\n| eval drilldown_user = if(NOT isnull(user), if(NOT isnull(SourceAccountName),(""event.SourceAccountName="" + $SourceAccountName$),""event.UserName="" + $UserName$ ),"""")\n| eval drilldown_dest = if(NOT isnull(dest), if(NOT isnull(SourceEndpointHostName),(""event.SourceEndpointHostName="" + $SourceEndpointHostName$ +""*""),""event.HostNames="" + $HostNames$ +""*""),"""")\n| eval drilldown_dest2 = if( NOT isnull(dest) AND NOT isnull(IOARuleInstanceID) AND Tactic==""Custom Intelligence"", if(NOT isnull(SourceEndpointHostName),(""dest="" + $SourceEndpointHostName$ +""*""),""dest="" + $HostNames$ +""*""),"""") \n| eval annotations.drilldown_search = if(isnull(IOARuleInstanceID) AND Tactic!=""Custom Intelligence"", ""`crowdstrike_stream` metadata.eventType="" + $metadata.eventType$ + "" "" + drilldown_user + "" "" + drilldown_dest, ""`crowdstrike_stream` ((metadata.eventType="" + $metadata.eventType$ + "" "" + drilldown_user + "" "" + drilldown_dest + "") OR (event_simpleName IN (CustomIOABasicProcessDetectionInfoEvent,CustomIOADomainNameDetectionInfoEvent,CustomIOAFileWrittenDetectionInfoEvent,CustomIOANetworkConnectionDetectionInfoEvent) TemplateInstanceId="" + IOARuleInstanceID + "" "" + drilldown_dest2 + ""))"")\n| rename ""metadata.eventType"" as eventType\n| eval title = case(Name==""NGAV"", (""RR - CS - "" + Tactic + "" - "" + Technique),Name==""Intel Detection"", (""RR - CS - "" + Name),eventType==""IdpDetectionSummaryEvent"", (""RR - CS - Identity Protection""),1==1, (""RR - CS - "" + Name + "" - "" + Technique) ) \n| eval user_append = if(NOT isnull(user),"" by "" + user,"""") \n| eval dest_append = if(NOT isnull(dest),"" on "" + dest,"""") \n| eval description = case(Name==""NGAV"", (""CS "" + Tactic + "" - "" + Technique + "": "" + FileName),eventType==""IdpDetectionSummaryEvent"", (""CS IdP"" + "" - "" + Name),Name==""Intel Detection"", (""CS "" + Name + "" - "" + IOCType + "": "" + IOCValue),1==1, (Objective + "" - "" + DetectDescription) ) \n| eval description = description + user_append + dest_append\n| eval gid=id, display_id=FalconHostLink, file_hash=SHA256String, hash=MD5String, signature=IOCValue, ip='NetworkAccesses{}.RemoteAddress', process=CommandLine, pid=ProcessId \n| eval file_name = if(isnull('ExecutablesWritten{}.FileName'), FileName, 'ExecutablesWritten{}.FileName')\n| rename id as detection_id, FalconHostLink as detection_url \n| table _time source detection_id detection_url title risk_score description Severity severity HostNames dest Tactic Technique user UserName Objective Name DetectDescription gid, display_id, mitre_technique annotations.mitre_attack annotations.drilldown_search file_hash hash signature ip process pid file_name\n| `crowdstrike_falcon_stream_alerts_filter`",11.0,11,
84,16,"`wineventlog_security` EventCode=5136 ObjectClass=domainDNS  | stats min(_time) as _time values(eval(if(OperationType==""%%14675"",AttributeValue,null))) as old_value values(eval(if(OperationType==""%%14674"",AttributeValue,null))) as new_value values(OperationType) as OperationType values(dest) as dest by ObjectClass ObjectDN OpCorrelationID src_user SubjectLogonId  | rex field=old_value max_match=10000 ""\((?P<old_values>.*?)\)""  | rex field=new_value max_match=10000 ""\((?P<new_ace>.*?)\)""  | mvexpand new_ace | where NOT new_ace IN (old_values)  | rex field=new_ace ""(?P<aceType>.*?);(?P<aceFlags>.*?);(?P<aceAccessRights>.*?);(?P<aceObjectGuid>.*?);;(?P<aceSid>.*?)$"" | search aceObjectGuid IN (""9923a32a-3607-11d2-b9be-0000f87a36b2"",""1131f6ab-9c07-11d1-f79f-00c04fc2dcd2"",""1131f6ac-9c07-11d1-f79f-00c04fc2dcd2"") | rex max_match=100 field=aceAccessRights ""(?P<AccessRights>[A-Z]{2})""  | rex max_match=100 field=aceFlags ""(?P<aceFlags>[A-Z]{2})""  | lookup msad_guid_lookup guid as aceObjectGuid OUTPUT displayName as ControlAccessRights | lookup ace_access_rights_lookup access_rights_string as AccessRights OUTPUT access_rights_value  | lookup ace_type_lookup ace_type_string as aceType OUTPUT ace_type_value  | lookup ace_flag_lookup flag_string as aceFlags OUTPUT flag_value as ace_flag_value ``` Optional SID resolution lookups | lookup identity_lookup_expanded objectSid as aceSid OUTPUT downLevelDomainName as user  | lookup admon_groups_def objectSid as aceSid OUTPUT cn as group ``` | lookup builtin_groups_lookup builtin_group_string  as aceSid OUTPUT builtin_group_name as builtin_group | eval aceType=coalesce(ace_type_value,aceType), aceFlags=coalesce(ace_flag_value,""This object only""), aceAccessRights=if(aceAccessRights=""CCDCLCSWRPWPDTLOCRSDRCWDWO"",""Full control"",coalesce(access_rights_value,AccessRights)), aceControlAccessRights=coalesce(ControlAccessRights,aceObjectGuid), user=coalesce(user, group, builtin_group, aceSid) | stats min(_time) as _time values(aceType) as aceType values(aceFlags) as aceFlags(inheritance) values(aceControlAccessRights) as aceControlAccessRights values(aceAccessRights) as aceAccessRights values(new_ace) as new_ace values(SubjectLogonId) as SubjectLogonId by ObjectClass ObjectDN src_user user | search (aceControlAccessRights=""Add/Remove Replica In Domain"" AND aceControlAccessRights=""Manage Replication Topology"" AND aceControlAccessRights=""Replication Synchronization"") OR (aceControlAccessRights=""9923a32a-3607-11d2-b9be-0000f87a36b2"" AND aceControlAccessRights=""1131f6ab-9c07-11d1-f79f-00c04fc2dcd2"" AND aceControlAccessRights=""1131f6ac-9c07-11d1-f79f-00c04fc2dcd2"") | `windows_ad_dcshadow_privileges_acl_addition_filter`",16.0,16,
85,10,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""netstat.exe"") (Processes.process=*-a*) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `network_connection_discovery_with_netstat_filter`",10.0,10,
86,12,| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name!=msbuild.exe AND Processes.original_file_name=MSBuild.exe by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `suspicious_msbuild_rename_filter`,12.0,12,
87,8,"`cisco_isovalent_process_exec` process_name=""sh""\n| rename process_exec.process.start_time as ProcessStartTime \n| rename process_exec.process.pod.container.start_time as ContainerStartTime \n| eval ProcessStartTime=strptime(ProcessStartTime, ""%Y-%m-%dT%H:%M:%S.%3Q"")\n| eval ContainerStartTime=strptime(ContainerStartTime, ""%Y-%m-%dT%H:%M:%S.%9Q"")\n| eval ContainerTime5min=relative_time(ContainerStartTime, ""+5m"")\n| where ProcessStartTime > ContainerTime5min\n| table node_name cluster_name, pod_name, container_id, process_name, process_exec, process, ProcessStartTime, ContainerTime5min | `security_content_ctime(ProcessStartTime)`\n| `security_content_ctime(ContainerTime5min)`\n| `cisco_isovalent___late_process_execution_filter`",8.0,8,
88,20,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=""whoami.exe"" Processes.process= ""*/priv*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `windows_system_user_privilege_discovery_filter`",20.0,20,
89,10,"| tstats earliest(_time) as firstTimeSeen, latest(_time) as lastTimeSeen from datamodel=Change where All_Changes.action=modified All_Changes.change_type=EC2 All_Changes.status=success by All_Changes.user | `drop_dm_object_name(""All_Changes"")` | inputlookup append=t previously_seen_cloud_instance_modifications_by_user | stats min(firstTimeSeen) as firstTimeSeen max(lastTimeSeen) as lastTimeSeen by user | where lastTimeSeen > relative_time(now(), `previously_seen_cloud_compute_images_forget_window`) | eventstats min(firstTimeSeen) as globalFirstTime | eval enough_data = if(globalFirstTime <= relative_time(now(), ""-7d@d""), 1, 0) | outputlookup previously_seen_cloud_instance_modifications_by_user",10.0,10,
90,13,"| tstats earliest(_time) as firstTime, latest(_time) as lastTime from datamodel=Change where (All_Changes.action=started OR All_Changes.action=created) All_Changes.status=success by All_Changes.src, All_Changes.user, All_Changes.object, All_Changes.command | `drop_dm_object_name(""All_Changes"")` | iplocation src | where isnotnull(Country) | lookup previously_seen_cloud_provisioning_activity_sources Country as Country OUTPUT firstTimeSeen, enough_data | eventstats max(enough_data) as enough_data | where enough_data=1 | eval firstTimeSeenCountry=min(firstTimeSeen) | where isnull(firstTimeSeenCountry) OR firstTimeSeenCountry > relative_time(now(), ""-24h@h"") | `security_content_ctime(firstTime)` | table firstTime, src, Country, user, object, command | `cloud_provisioning_activity_from_previously_unseen_country_filter`",13.0,13,
91,5,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Network_Traffic where All_Traffic.app=tor AND All_Traffic.action IN (""allowed"", ""allow"") by All_Traffic.action All_Traffic.app All_Traffic.bytes All_Traffic.bytes_in All_Traffic.bytes_out All_Traffic.dest All_Traffic.dest_ip All_Traffic.dest_port All_Traffic.dvc All_Traffic.protocol All_Traffic.protocol_version All_Traffic.src All_Traffic.src_ip All_Traffic.src_port All_Traffic.transport All_Traffic.user All_Traffic.vendor_product All_Traffic.rule | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `drop_dm_object_name(""All_Traffic"")` | `tor_traffic_filter`",5.0,5,
92,9,"| tstats `security_content_summariesonly` count earliest(_time) as firstTime latest(_time) as lastTime values(All_Traffic.action) as action values(All_Traffic.bytes) as bytes from datamodel=Network_Traffic where All_Traffic.action !=blocked (All_Traffic.protocol=icmp OR All_Traffic.transport=icmp) All_Traffic.bytes > 1000 AND NOT All_Traffic.dest_ip IN (""10.0.0.0/8"",""172.16.0.0/12"",""192.168.0.0/16"") by All_Traffic.action All_Traffic.app All_Traffic.bytes All_Traffic.bytes_in All_Traffic.bytes_out All_Traffic.dest All_Traffic.dest_ip All_Traffic.dest_port All_Traffic.dvc All_Traffic.protocol All_Traffic.protocol_version All_Traffic.src All_Traffic.src_ip All_Traffic.src_port All_Traffic.transport All_Traffic.user All_Traffic.vendor_product | `drop_dm_object_name(""All_Traffic"")` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | iplocation dest_ip | `detect_large_outbound_icmp_packets_filter`",9.0,9,
93,6,"`amazon_security_lake` api.operation=""AssumeRole"" ""api.response.error""=AccessDenied | bucket _time span=1h | stats count as failures min(_time) as firstTime max(_time) as lastTime values(api.operation) as api.operation values(api.service.name) as api.service.name values(http_request.user_agent) as http_request.user_agent values(src_endpoint.ip) as src_ip values(actor.user.account.uid) as actor.user.account.uid values(cloud.provider) as cloud.provider values(cloud.region) as cloud.region by _time actor.user.uid | where failures >= 3 | rename actor.user.uid as user api.operation as action api.service.name as dest http_request.user_agent as user_agent src_endpoint.ip as src actor.user.account.uid as vendor_account cloud.provider as vendor_product cloud.region as vendor_region | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `asl_aws_iam_assume_role_policy_brute_force_filter`",6.0,6,
94,5,"`wineventlog_security` EventCode=4624 LogonType=3 TargetUserName!=""ANONYMOUS LOGON"" TargetUserName!=""*$"" | bucket span=5m _time | stats dc(Computer) AS unique_targets values(Computer) as host_targets values(dest) as dest values(src) as src values(user) as user by _time, IpAddress, TargetUserName, action, app, authentication_method, signature, signature_id | where unique_targets > 30 | `windows_rapid_authentication_on_multiple_hosts_filter`",5.0,5,
95,6,| tstats `security_content_summariesonly` count values(Processes.process) as process values(Processes.parent_process) as parent_process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=schtasks.exe (Processes.process=*delete* OR Processes.process=*create*) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `scheduled_task_deleted_or_created_via_cmd_filter`,6.0,6,
96,5,"`o365_management_activity` Workload=AzureActiveDirectory Operation=""Consent to application."" ResultStatus=Failure | eval permissions =mvindex('ModifiedProperties{}.NewValue', 4) | eval reason =mvindex('ModifiedProperties{}.NewValue', 5) | search reason = ""Risky application detected"" | rex field=permissions ""Scope: (?<Scope>[^,]+)"" | fillnull | stats max(_time) as lastTime by user, reason, object, Scope, dest, src, vendor_account, vendor_product, signature | `security_content_ctime(lastTime)` | `o365_user_consent_blocked_for_risky_application_filter`",5.0,5,
97,7,"| mstats avg(process.cpu.utilization) as process.cpu.utilization avg(process.memory.utilization) as process.memory.utilization where `kubernetes_metrics` AND process.executable.name IN (""sh"",""bash"",""csh"", ""tcsh"") by host.name k8s.cluster.name k8s.node.name process.pid process.executable.name span=10s | search process.cpu.utilization>0 | stats avg(process.cpu.utilization) as process.cpu.utilization avg(process.memory.utilization) as process.memory.utilization by host.name k8s.cluster.name k8s.node.name process.pid process.executable.name | rename host.name as host | `kubernetes_shell_running_on_worker_node_with_cpu_activity_filter`",7.0,7,
98,21,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime sum(All_Risk.calculated_risk_score) as risk_score, count(All_Risk.calculated_risk_score) as risk_event_count, values(All_Risk.annotations.mitre_attack.mitre_tactic_id) as annotations.mitre_attack.mitre_tactic_id, dc(All_Risk.annotations.mitre_attack.mitre_tactic_id) as mitre_tactic_id_count, values(All_Risk.annotations.mitre_attack.mitre_technique_id) as annotations.mitre_attack.mitre_technique_id, dc(All_Risk.annotations.mitre_attack.mitre_technique_id) as mitre_technique_id_count, values(All_Risk.tag) as tag, values(source) as source, dc(source) as source_count from datamodel=Risk.All_Risk where source IN (""*Windows Cmdline Tool Execution From Non-Shell Process*"", ""*Windows System Network Config Discovery Display DNS*"", ""*Local Account Discovery With Wmic*"", ""*Windows Group Discovery Via Net*"", ""*Windows Create Local Administrator Account Via Net*"", ""*Windows User Discovery Via Net*"", ""*Icacls Deny Command*"", ""*ICACLS Grant Command*"", ""*Windows Proxy Via Netsh*"", ""*Processes launching netsh*"", ""*Disabling Firewall with Netsh*"", ""*Windows System Network Connections Discovery Netsh*"", ""*Network Connection Discovery With Arp*"", ""*Windows System Discovery Using ldap Nslookup*"", ""*Windows System Shutdown CommandLine*"") by All_Risk.risk_object All_Risk.risk_object_type All_Risk.annotations.mitre_attack.mitre_tactic | `drop_dm_object_name(All_Risk)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | where source_count >= 4 | `windows_common_abused_cmd_shell_risk_behavior_filter`",21.0,21,
99,11,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_rundll32` Processes.process=*comsvcs.dll* Processes.process IN (""*MiniDump*"", ""*#24*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `dump_lsass_via_comsvcs_dll_filter`",11.0,11,
100,11,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name = chown OR Processes.process = ""*chown *"") AND Processes.process = ""* root *"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `linux_change_file_owner_to_root_filter`",11.0,11,
101,19,"`o365_management_activity` Workload=SecurityComplianceCenter Operation=""SearchExported"" | rename user_id as user | fillnull | stats count min(_time) as firstTime max(_time) as lastTime by signature dest user src vendor_account vendor_product ExchangeLocations Query | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `o365_compliance_content_search_exported_filter`",19.0,19,
102,13,"`o365_messagetrace` subject IN (""*banking*"",""*direct deposit*"",""*pay-to*"",""*password *"",""*passcode *"",""*OTP *"",""*MFA *"",""*Account Recovery*"")\n| eval mailtime = _time\n| bin _time span=4hr\n| eval user = lower(RecipientAddress)\n| eval InternetMessageId = lower(MessageId)\n| join InternetMessageId, user max=0\n  [\n  | search `o365_management_activity` Workload=Exchange Operation IN (""HardDelete"") AND Folder.Path IN (""\\Sent Items"",""\\Recoverable Items\\Deletions"")\n  | spath path=AffectedItems{}  output=AffectedItemSplit\n  | fields _time,ClientProcessName,ClientIPAddress,ClientInfoString,UserId,Operation,ResultStatus,MailboxOwnerUPN,AffectedItemSplit,Folder.Path \n  | mvexpand AffectedItemSplit | spath input=AffectedItemSplit\n  | search Subject IN (""*banking*"",""*direct deposit*"",""*pay-to*"",""*password *"",""*passcode *"",""*OTP *"",""*MFA *"",""*Account Recovery*"") \n  | eval deltime = _time\n  | bin _time span=4hr\n  | eval InternetMessageId = lower(InternetMessageId), user = lower(UserId), subject = Subject\n  ]\n| stats values(ClientIPAddress) as src, values(ClientInfoString) as http_user_agent, values(Folder.Path) as file_path, values(Operation) as signature, values(ResultStatus) as result, values(InternetMessageId) as signature_id, count, min(mailtime) as firstTime, max(deltime) as lastTime by user,subject\n| `security_content_ctime(firstTime)` \n| `security_content_ctime(lastTime)`\n| `o365_email_receive_and_hard_delete_takeover_behavior_filter`",13.0,13,
103,10,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where  Processes.process_name IN (""bash"",""cat"") Processes.process IN (""*/authorized_keys*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `linux_ssh_authorized_keys_modification_filter`",10.0,10,
104,6,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name IN (""systemctl"", ""service"", ""svcadm"")  Processes.process = ""* disable*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `linux_disable_services_filter`",6.0,6,
105,9,"`linux_auditd`\n(type=PATH OR type=CWD)\n| rex ""msg=audit\([^)]*:(?<audit_id>\d+)\)""\n\n| stats\n  values(type) as types\n  values(name) as names\n  values(nametype) as nametype\n  values(cwd) as cwd_list\n  values(_time) as event_times\n  by audit_id, host\n\n| eval current_working_directory = coalesce(mvindex(cwd_list, 0), ""N/A"")\n| eval candidate_paths = mvmap(names, if(match(names, ""^/""), names, current_working_directory + ""/"" + names))\n| eval matched_paths = mvfilter(match(candidate_paths, ""/etc/ld.so.preload.*""))\n| eval match_count = mvcount(matched_paths)\n| eval reconstructed_path = mvindex(matched_paths, 0)\n| eval e_time = mvindex(event_times, 0)\n| where match_count > 0\n| rename host as dest\n\n| stats count min(e_time) as firstTime max(e_time) as lastTime\n  values(nametype) as nametype\n  by current_working_directory\n     reconstructed_path\n     match_count\n     dest\n     audit_id\n\n| `security_content_ctime(firstTime)`\n| `security_content_ctime(lastTime)`\n| `linux_auditd_preload_hijack_via_preload_file_filter`",9.0,9,
106,5,"`ntlm_audit`\nEventCode = 8004\nSChannelName=* WorkstationName=*\n```CIM alignment, remove leading \\ from some auth attempts ```\n| eval src = replace(WorkstationName,""\\\\"","""")\n| eval dest = SChannelName, user = UserName\n\n``` Remove NTLM auths to self, improves accuracy for certain applications ```\n| where SChannelName!=src\n\n| stats count min(_time) as firstTime\n              max(_time) as lastTime\n              dc(eval(upper(dest))) as unique_count by src\n| eventstats avg(unique_count) as unique_avg\n             stdev(unique_count) as unique_std\n\n``` adjust formula for sensitivity```\n| eval upperBound_unique=(1+unique_avg+unique_std*3)\n\n| eval isOutlier=CASE(unique_count > upperBound_unique, 1, true(), 0)\n| where isOutlier==1\n| `security_content_ctime(firstTime)`\n| `security_content_ctime(lastTime)`\n| `windows_unusual_ntlm_authentication_destinations_by_source_filter`",5.0,5,
107,6,"| dnstwist domainlist=domains.csv | `remove_valid_domains` | eval domain_abuse=""true"" | table domain, domain_abuse | outputlookup brandMonitoring_lookup | stats count",6.0,6,
108,7,"| tstats count as instances_destroyed values(All_Changes.object_id) as object_id from datamodel=Change where All_Changes.action=deleted AND All_Changes.status=success AND All_Changes.object_category=instance by All_Changes.user _time span=1h | `drop_dm_object_name(""All_Changes"")` | eval HourOfDay=strftime(_time, ""%H"") | eval HourOfDay=floor(HourOfDay/4)*4 | eval DayOfWeek=strftime(_time, ""%w"") | eval isWeekend=if(DayOfWeek >= 1 AND DayOfWeek <= 5, 0, 1) | join HourOfDay isWeekend [summary cloud_excessive_instances_destroyed_v1] | where cardinality >=16 | apply cloud_excessive_instances_destroyed_v1 threshold=0.005 | rename ""IsOutlier(instances_destroyed)"" as isOutlier | where isOutlier=1 | eval expected_upper_threshold = mvindex(split(mvindex(BoundaryRanges, -1), "":""), 0) | eval distance_from_threshold = instances_destroyed - expected_upper_threshold | table _time, user, instances_destroyed, expected_upper_threshold, distance_from_threshold, object_id | `abnormally_high_number_of_cloud_instances_destroyed_filter`",7.0,7,
109,7,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = ""python*.exe"" Processes.process = ""*.py*"" Processes.process = ""*-ntds*"" (Processes.process = ""*-system*"" OR Processes.process = ""*-sam*"" OR Processes.process = ""*-security*"" OR Processes.process = ""*-bootkey*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `secretdumps_offline_ntds_dumping_tool_filter`",7.0,7,
110,6,"`cloudtrail` eventSource=ecr.amazonaws.com eventName=DescribeImageScanFindings | spath path=responseElements.imageScanFindings.findings{} output=findings | mvexpand findings | spath input=findings | search severity=MEDIUM | rename name as finding_name, description as finding_description, requestParameters.imageId.imageDigest as imageDigest, requestParameters.repositoryName as repository | rename user_name as user | stats count min(_time) as firstTime max(_time) as lastTime by signature dest user user_agent src vendor_account vendor_region vendor_product finding_name finding_description imageDigest repository | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `aws_ecr_container_scanning_findings_medium_filter`",6.0,6,
111,12,"`azure_monitor_aad` category=AuditLogs operationName=""Disable Strong Authentication"" | rename properties.* as * | rename targetResources{}.type as type | rename initiatedBy.user.userPrincipalName as initiatedBy | rename userAgent as user_agent | fillnull | stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product user_agent initiatedBy signature | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `azure_ad_multi_factor_authentication_disabled_filter`",12.0,12,
112,14,`cloudtrail` (eventName= DeleteVirtualMFADevice OR eventName=DeactivateMFADevice) | rename user_name as user | stats count min(_time) as firstTime max(_time) as lastTime by signature dest user user_agent src vendor_account vendor_region vendor_product | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `aws_multi_factor_authentication_disabled_filter`,14.0,14,
113,22,`cloudtrail` eventName = DeleteLogGroup eventSource = logs.amazonaws.com userAgent !=console.amazonaws.com errorCode = success | rename user_name as user | stats count min(_time) as firstTime max(_time) as lastTime by signature dest user user_agent src vendor_account vendor_region vendor_product | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)`| `aws_defense_evasion_delete_cloudwatch_log_group_filter`,22.0,22,
114,17,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""powershell.exe"") (Processes.process=*Get-WmiObject* AND Processes.process=""*namespace root\\directory\\ldap*"" AND Processes.process=""*class ds_computer*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `getwmiobject_ds_computer_with_powershell_filter`",17.0,17,
115,17,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.parent_process_name = ""cscript.exe"" AND Processes.parent_process = ""*//e:jscript*"") OR (Processes.process_name = ""cscript.exe"" AND Processes.process = ""*//e:jscript*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `jscript_execution_using_cscript_app_filter`",17.0,17,
116,11,"`netbackup` ""Disk/Partition backup completed successfully."" | bucket _time span=1d | stats dc(COMPUTERNAME) as count values(COMPUTERNAME) as dest by _time, MESSAGE",11.0,11,
117,19,"`wineventlog_security` EventCode=4776 TargetUserName!=*$ Status=0xC000006A | bucket span=5m _time | stats dc(TargetUserName) AS unique_accounts values(TargetUserName) as tried_accounts values(dest) as dest by _time, Workstation | where unique_accounts > 30 | `windows_multiple_users_failed_to_authenticate_from_host_using_ntlm_filter`",19.0,19,
118,12,"`o365_management_activity` Workload=ThreatIntelligence Operation=TIMailData DeliveryAction!=Blocked Directionality=InBound | rename P2Sender as src_user, P1Sender as sender, Recipients{} as user, DeliveryAction as action | stats values(SenderIp) as src, values(Subject) as subject, values(user) as user, values(action) as action, values(SystemOverrides{}.Details) as reason, values(LatestDeliveryLocation) as result, values(ThreatsAndDetectionTech{}) as category, values(AttachmentData{}.FileName) as file_name, values(AttachmentData{}.FileType) as file_type, values(AttachmentData{}.SHA256) as file_hash values(DetectionMethod) as signature, min(_time) as firstTime max(_time) as lastTime, count by src_user,sender,dest,vendor_account,vendor_product | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `o365_threat_intelligence_suspicious_email_delivered_filter`",12.0,12,
119,10,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_net` Processes.process=""*group*"" Processes.process IN (""*Domain Admins*"", ""*Enterprise Admins*"", ""*Schema Admins*"", ""*Account Operators*"", ""*Server Operators*"", ""*Protected Users*"", ""*Dns Admins*"", ""*Domain Computers*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `windows_sensitive_group_discovery_with_net_filter`",10.0,10,
120,12,"| tstats count min(_time) as firstTime max(_time) as lastTime values(Processes.process_current_directory) as directory from datamodel=Endpoint.Processes where Processes.parent_process_name != ""unknown"" Processes.process_name IN (""appvlp.exe"",""bitsadmin.exe"",""control.exe"",""cscript.exe"",""forfiles.exe"",""ftp.exe"",""mavinject.exe"",""mshta.exe"",""powershell.exe"",""powershell_ise.exe"",""pwsh.exe"",""regini.exe"",""regscr32.exe"",""rundll32.exe"",""sc.exe"",""wmic.exe"",""wscript.exe"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product | `drop_dm_object_name(Processes)` | regex process=""(\b)\w+(\.\w+)?:\w+(\.\w{2,4})(?!\.)(\b|\s|&)"" | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `windows_alternate_datastream___process_execution_filter`",12.0,12,
121,10,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process  IN (""*/stext *"", ""*/shtml *"", ""*/LoadPasswordsIE*"", ""*/LoadPasswordsFirefox*"", ""*/LoadPasswordsChrome*"", ""*/LoadPasswordsOpera*"", ""*/LoadPasswordsSafari*"" , ""*/UseOperaPasswordFile*"", ""*/OperaPasswordFile*"",""*/stab*"", ""*/scomma*"", ""*/stabular*"", ""*/shtml*"", ""*/sverhtml*"", ""*/sxml*"", ""*/skeepass*"" ) AND Processes.process IN (""*\\temp\\*"", ""*\\users\\public\\*"", ""*\\programdata\\*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `possible_browser_pass_view_parameter_filter`",10.0,10,
122,5,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=mmc.exe (Processes.process =*gpme.msc*) AND (Processes.process = ""*31B2F340-016D-11D2-945F-00C04FB984F9*"" OR Processes.process = ""*6AC1786C-016F-11D2-945F-00C04fB984F9*""  ) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `windows_default_group_policy_object_modified_with_gpme_filter`",5.0,5,
123,7,"| tstats `security_content_summariesonly` count from datamodel=Web where Web.dest_category=web_server AND (Web.url_length > 1024 OR Web.http_user_agent_length > 200) by Web.src Web.dest Web.url Web.url_length Web.http_user_agent | `drop_dm_object_name(""Web"")` | eval url=lower(url) | eval num_sql_cmds=mvcount(split(url, ""alter%20table"")) + mvcount(split(url, ""between"")) + mvcount(split(url, ""create%20table"")) + mvcount(split(url, ""create%20database"")) + mvcount(split(url, ""create%20index"")) + mvcount(split(url, ""create%20view"")) + mvcount(split(url, ""delete"")) + mvcount(split(url, ""drop%20database"")) + mvcount(split(url, ""drop%20index"")) + mvcount(split(url, ""drop%20table"")) + mvcount(split(url, ""exists"")) + mvcount(split(url, ""exec"")) + mvcount(split(url, ""group%20by"")) + mvcount(split(url, ""having"")) + mvcount(split(url, ""insert%20into"")) + mvcount(split(url, ""inner%20join"")) + mvcount(split(url, ""left%20join"")) + mvcount(split(url, ""right%20join"")) + mvcount(split(url, ""full%20join"")) + mvcount(split(url, ""select"")) + mvcount(split(url, ""distinct"")) + mvcount(split(url, ""select%20top"")) + mvcount(split(url, ""union"")) + mvcount(split(url, ""xp_cmdshell"")) - 24 | where num_sql_cmds > 3 | `sql_injection_with_long_urls_filter`",7.0,7,
124,11,"`cloudwatchlogs_vpcflow` action=blocked (src_ip=10.0.0.0/8 OR src_ip=172.16.0.0/12 OR src_ip=192.168.0.0/16) ( dest_ip!=10.0.0.0/8 AND dest_ip!=172.16.0.0/12 AND dest_ip!=192.168.0.0/16)  [search  `cloudwatchlogs_vpcflow` action=blocked (src_ip=10.0.0.0/8 OR src_ip=172.16.0.0/12 OR src_ip=192.168.0.0/16) ( dest_ip!=10.0.0.0/8 AND dest_ip!=172.16.0.0/12 AND dest_ip!=192.168.0.0/16)  | stats count as numberOfBlockedConnections by src_ip | inputlookup baseline_blocked_outbound_connections append=t | fields - latestCount | stats values(*) as * by src_ip | rename numberOfBlockedConnections as latestCount | eval newAvgBlockedConnections=avgBlockedConnections + (latestCount-avgBlockedConnections)/720 | eval newStdevBlockedConnections=sqrt(((pow(stdevBlockedConnections, 2)*719 + (latestCount-newAvgBlockedConnections)*(latestCount-avgBlockedConnections))/720)) | eval avgBlockedConnections=coalesce(newAvgBlockedConnections, avgBlockedConnections), stdevBlockedConnections=coalesce(newStdevBlockedConnections, stdevBlockedConnections), numDataPoints=if(isnull(latestCount), numDataPoints, numDataPoints+1) | table src_ip, latestCount, numDataPoints, avgBlockedConnections, stdevBlockedConnections | outputlookup baseline_blocked_outbound_connections | eval dataPointThreshold = 5, deviationThreshold = 3 | eval isSpike=if((latestCount > avgBlockedConnections+deviationThreshold*stdevBlockedConnections) AND numDataPoints > dataPointThreshold, 1, 0) | where isSpike=1 | table src_ip] | stats values(dest_ip) as dest_ip, values(interface_id) as ""resourceId"" count as numberOfBlockedConnections, dc(dest_ip) as uniqueDestConnections by src_ip | `detect_spike_in_blocked_outbound_traffic_from_your_aws_filter`",11.0,11,
125,11," | tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where (Web.status=200) AND Web.http_method=POST by Web.src Web.status Web.uri_path Web.dest Web.http_method Web.uri_query Web.http_user_agent | `drop_dm_object_name(""Web"")` | eval is_autodiscover=if(like(lower(uri_path),""%autodiscover/autodiscover.json%""),1,0) | eval has_rps_cat=if(like(lower(uri_query),""%x-rps-cat=%""),1,0) | eval exchange_backend=if(like(lower(uri_query),""%/powershell/?%""),1,0) | eval mapi=if(like(uri_query,""%/mapi/%""),1,0) | eval suspicious_agent=if(match(lower(http_user_agent), ""python|urllib""),1,0) | addtotals fieldname=Score is_autodiscover, has_rps_cat, exchange_backend, mapi, suspicious_agent | where Score >= 3 | fields Score, src, dest, status, uri_query, uri_path, http_method, http_user_agent | `windows_exchange_autodiscover_ssrf_abuse_filter`",11.0,11,
126,13,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where  Processes.process_name = pkgmgr.exe Processes.process = ""*.xml*"" NOT(Processes.parent_process_path IN(""*:\\windows\\system32\\*"", ""*:\\windows\\syswow64\\*"", ""*:\\Program Files*"")) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `windows_bypass_uac_via_pkgmgr_tool_filter`",13.0,13,
127,16,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name = setcap OR Processes.process = ""*setcap *"") AND Processes.process IN (""* cap_setuid=ep *"", ""* cap_setuid+ep *"", ""* cap_net_bind_service+p *"", ""* cap_net_raw+ep *"", ""* cap_dac_read_search+ep *"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `linux_setuid_using_setcap_utility_filter`",16.0,16,
